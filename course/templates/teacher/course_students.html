{% load static %}
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ course.name }} - 名單 / 成績 / 留言</title>
  <link rel="stylesheet" href="{% static 'css/app.css' %}">
</head>

<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="container topbar__inner">
      <div class="brand">
        <span class="brand__dot"></span>
        <a class="brand__text" href="{% url 'teacher_courses' %}">教師系統</a>
      </div>

      <div class="nav">
        <a class="nav__link" href="{% url 'teacher_courses' %}">我的課程</a>

        <form method="post" action="{% url 'logout' %}" style="display:inline;">
          {% csrf_token %}
          <button class="nav__link" type="submit" style="background:transparent;border:none;cursor:pointer;">登出</button>
        </form>
      </div>
    </div>
  </div>

  <main class="container" style="padding:18px 0 30px;">
    <!-- Course Info -->
    <div class="card">
      <h1>{{ course.name }}</h1>
      <div class="muted">
        <div>學期：{{ course.semester }}</div>
        <div>任課老師：{{ course.teacher.username }}</div>
      </div>
    </div>

    <!-- 成績輸入 -->
    <div class="card">
      <h2>修課學生名單 / 輸入成績</h2>

      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="_action" value="save_grades">

        <table class="table">
          <tr>
            <th>學生</th>
            <th>期中</th>
            <th>期末</th>
          </tr>

          {% for e in enrollments %}
            <tr>
              <td>{{ e.student.username }}</td>
              <td>
                <input class="input" type="number" step="0.5" name="mid_{{ e.id }}"
                       value="{{ e.midterm|default_if_none:'' }}">
              </td>
              <td>
                <input class="input" type="number" step="0.5" name="final_{{ e.id }}"
                       value="{{ e.final|default_if_none:'' }}">
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="3">目前尚無學生修課</td></tr>
          {% endfor %}
        </table>

        <div class="row" style="margin-top:12px;">
          <button class="btn" type="submit">儲存成績</button>
          <a class="btn btn--ghost" href="{% url 'teacher_courses' %}">返回教師首頁</a>
        </div>
      </form>
    </div>

    <!-- 留言區 -->
    <div class="card">
      <h2>學生留言</h2>

      {% for c in comments %}
        <div class="comment">
          <div class="comment__head">
            {% if c.user.profile.avatar %}
              <img class="avatar" src="{{ c.user.profile.avatar.url }}" alt="avatar">
            {% else %}
              <div class="avatar avatar--fallback"></div>
            {% endif %}

            <div>
              <div><b>{{ c.user.profile.full_name|default:c.user.username }}</b></div>
              <div class="comment__meta">{{ c.created_at|date:"Y-m-d H:i" }}</div>
            </div>
          </div>

          <div style="margin-top:10px; white-space:pre-wrap;">{{ c.content }}</div>

          <!-- 顯示回覆 -->
          {% for r in c.replies.all %}
            <div class="reply">
              <div class="comment__head" style="margin-bottom:6px;">
                {% if r.user.profile.avatar %}
                  <img class="avatar" src="{{ r.user.profile.avatar.url }}" alt="avatar">
                {% else %}
                  <div class="avatar avatar--fallback"></div>
                {% endif %}

                <div>
                  <div>
                    <b>{{ r.user.profile.full_name|default:r.user.username }}</b>
                    <span class="pill pill--blue">老師回覆</span>
                  </div>
                  <div class="comment__meta">{{ r.created_at|date:"Y-m-d H:i" }}</div>
                </div>
              </div>
              <div style="white-space:pre-wrap;">{{ r.content }}</div>
            </div>
          {% endfor %}

          <!-- 老師回覆 -->
          <form method="post" action="{% url 'reply_comment' c.id %}" style="margin-top:12px;">
            {% csrf_token %}
            <label>老師回覆</label>
            <textarea name="content" rows="2" placeholder="輸入回覆內容..."></textarea>
            <div class="row" style="margin-top:10px;">
              <button class="btn" type="submit">送出回覆</button>
            </div>
          </form>
        </div>
      {% empty %}
        <p class="muted">目前尚無留言。</p>
      {% endfor %}
    </div>
  </main>
</body>
</html>
